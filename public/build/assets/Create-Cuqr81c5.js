import{x as q,r as b,o as B,E as R,c as a,a as i,b as C,u as n,g as J,w as M,d as t,j as c,S as j,i as V,t as g,h as K,q as v,F as U,e as Q,y as W,v as T,n as X,D as E,A as H}from"./app-BvKMgCPM.js";import{_ as Y}from"./AppLayout-CPl3rLGK.js";const Z={class:"py-6"},ee={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},te={class:"bg-white dark:bg-gray-800 overflow-hidden shadow-sm sm:rounded-lg p-6"},se={class:"max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8"},le={class:"flex justify-between mb-6"},oe={key:0,class:"bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6"},ne={key:1,class:"bg-red-50 border-l-4 border-red-400 p-4 mb-6"},re={class:"flex"},ae={class:"ml-3"},ie={class:"text-sm text-red-700"},de={class:"mb-4"},ue=["value"],ce={key:0,class:"text-red-500 text-sm mt-1"},me={class:"mb-4"},ge={key:0,class:"text-red-500 text-sm mt-1"},pe={class:"mb-4"},fe={class:"flex mb-4 space-x-4"},be=["disabled"],ve={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},xe={class:"flex-1 text-right"},he={class:"text-sm text-gray-500"},ye={class:"mb-4 relative"},we={key:0,class:"absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center z-10"},ke=["disabled"],_e={key:1,class:"text-red-500 text-sm mt-1"},Ce={class:"mb-4"},Me={class:"flex items-center space-x-4"},Te={key:0,class:"text-red-500 text-sm mt-1"},Ae={key:0,class:"mb-4"},Ge={key:0,class:"text-red-500 text-sm mt-1"},Se={class:"flex justify-end"},ze={__name:"Create",props:{channels:Array,errors:Object},setup(d){const w=d,s=q({channel_id:"",title:"",content:"",custom_prompt:"",publish_type:"now",scheduled_at:null}),u=b(""),r=b(!1),z=b(""),A=b(""),k=b(null),_=b(null),G=b(!1),N=async()=>{try{const o=await H.get("/api/config/gigachat-test-mode");G.value=o.data.enabled}catch(o){console.error("Ошибка при проверке тестового режима:",o),G.value=!1}},D=()=>s.content&&typeof s.content=="string"?s.content.length:0;B(()=>{var e;const o=new Date;o.setMinutes(o.getMinutes()+5),s.scheduled_at=o.toISOString().slice(0,16),N(),console.log("Channels available:",((e=w.channels)==null?void 0:e.length)??0),console.log("First channel:",w.channels&&w.channels.length>0?w.channels[0]:"No channels")});const F=()=>{console.log("Channel selected:",s.channel_id)},O=()=>{console.log("Submitting form with publish_type:",s.publish_type),s.publish_type==="now"&&(s.scheduled_at=null),s.post(route("posts.store"),{onSuccess:()=>{},onError:o=>{console.error("Errors:",o)}})},x=()=>{k.value&&(clearInterval(k.value),k.value=null),_.value&&(clearTimeout(_.value),_.value=null)},P=o=>{if(!o){r.value=!1,u.value="Получен пустой ответ от сервера";return}x(),z.value=o,A.value="";let e=0;const l=o.includes("⚠️ ТЕСТОВЫЙ РЕЖИМ GIGACHAT ⚠️"),p=l?5:15;_.value=setTimeout(()=>{r.value&&(x(),s.content=z.value,r.value=!1)},l?15e3:3e4),k.value=setInterval(()=>{e<o.length?(A.value+=o[e],s.content=A.value,e++):(x(),r.value=!1)},p)},$=async()=>{var o,e,l;if(!s.channel_id){u.value="Выберите канал для генерации поста";return}x();try{r.value=!0,s.content="";const p=new AbortController,f=setTimeout(()=>p.abort(),6e4),y=await H.post(route("posts.generate"),{channel_id:s.channel_id,title:s.title,custom_prompt:s.custom_prompt},{signal:p.signal});if(clearTimeout(f),y.data&&y.data.success&&y.data.content){let h=y.data.content;const L=h.includes("⚠️ ТЕСТОВЫЙ РЕЖИМ GIGACHAT ⚠️");if(P(h),!s.title&&h){L&&(h=h.replace("⚠️ ТЕСТОВЫЙ РЕЖИМ GIGACHAT ⚠️","").trim());const m=h.split(`
`);if(m.length>0){let S="";for(const I of m)if(I.trim()&&!I.includes("ТЕСТОВЫЙ РЕЖИМ")){S=I;break}S&&(s.title=S.substring(0,50).replace(/[#*_]/g,""))}}if(L){const m=document.createElement("div");m.className="fixed bottom-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-lg",m.innerHTML='<div class="flex items-center"><svg class="h-6 w-6 text-yellow-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><div><p class="font-bold">Тестовый режим GigaChat</p><p class="text-sm">Приложение работает в тестовом режиме. Ответы генерируются локально.</p></div></div>',document.body.appendChild(m),setTimeout(()=>{m.style.opacity="0",m.style.transition="opacity 0.5s ease",setTimeout(()=>m.remove(),500)},5e3)}u.value=""}else u.value=((o=y.data)==null?void 0:o.message)||"Ошибка при генерации поста",r.value=!1,s.content=""}catch(p){if(x(),console.error("Ошибка при генерации поста:",p),p.name==="AbortError")u.value="Превышено время ожидания ответа от сервера. Рекомендуем включить тестовый режим GigaChat.";else{const f=(l=(e=p.response)==null?void 0:e.data)==null?void 0:l.message;f?(u.value=f,(f.includes("GigaChat API")||f.includes("токен")||f.includes("авторизац")||f.includes("подключен"))&&(u.value+=" Рекомендуем включить тестовый режим GigaChat для продолжения работы.")):u.value="Произошла ошибка при генерации поста. Пожалуйста, введите текст вручную или включите тестовый режим GigaChat."}r.value=!1,s.content=""}};return R(()=>s.publish_type,o=>{if(o==="now")s.scheduled_at=null;else if(o==="scheduled"&&!s.scheduled_at){const e=new Date;e.setMinutes(e.getMinutes()+5),s.scheduled_at=e.toISOString().slice(0,16)}}),B(()=>()=>{x()}),(o,e)=>(i(),a(U,null,[C(n(J),{title:"Создать пост"}),C(Y,null,{header:M(()=>e[9]||(e[9]=[t("div",{class:"flex justify-between items-center"},[t("h2",{class:"text-xl font-semibold text-gray-800 dark:text-gray-200 leading-tight"}," Создать пост ")],-1)])),default:M(()=>[t("div",Z,[t("div",ee,[t("div",te,[t("div",se,[t("div",le,[e[11]||(e[11]=t("h1",{class:"text-2xl font-semibold text-gray-800"},"Создание нового поста",-1)),C(n(j),{href:o.route("posts.index"),class:"px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 flex items-center"},{default:M(()=>e[10]||(e[10]=[t("span",{class:"mr-1"},"← Назад к списку",-1)])),_:1},8,["href"])]),G.value?(i(),a("div",oe,e[12]||(e[12]=[t("div",{class:"flex"},[t("div",{class:"flex-shrink-0"},[t("svg",{class:"h-5 w-5 text-yellow-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z","clip-rule":"evenodd"})])]),t("div",{class:"ml-3"},[t("p",{class:"text-sm text-yellow-700"},[t("span",{class:"font-medium"},"Тестовый режим GigaChat включен."),V(" Ответы генерируются локально без обращения к API. ")])])],-1)]))):c("",!0),u.value?(i(),a("div",ne,[t("div",re,[e[13]||(e[13]=t("div",{class:"flex-shrink-0"},[t("svg",{class:"h-5 w-5 text-red-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor"},[t("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})])],-1)),t("div",ae,[t("p",ie,g(u.value),1)])])])):c("",!0),t("form",{onSubmit:K(O,["prevent"])},[t("div",de,[e[15]||(e[15]=t("label",{for:"channel",class:"block text-sm font-medium text-gray-700"},"Канал",-1)),v(t("select",{id:"channel","onUpdate:modelValue":e[0]||(e[0]=l=>n(s).channel_id=l),onChange:F,class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"},[e[14]||(e[14]=t("option",{value:""},"Выберите канал",-1)),(i(!0),a(U,null,Q(d.channels,l=>(i(),a("option",{key:l.id,value:l.id},g(l.name),9,ue))),128))],544),[[W,n(s).channel_id]]),d.errors.channel_id?(i(),a("div",ce,g(d.errors.channel_id),1)):c("",!0)]),t("div",me,[e[16]||(e[16]=t("label",{for:"title",class:"block text-sm font-medium text-gray-700"},"Заголовок",-1)),v(t("input",{id:"title",type:"text","onUpdate:modelValue":e[1]||(e[1]=l=>n(s).title=l),class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"},null,512),[[T,n(s).title]]),d.errors.title?(i(),a("div",ge,g(d.errors.title),1)):c("",!0)]),t("div",pe,[e[17]||(e[17]=t("label",{for:"custom_prompt",class:"block text-sm font-medium text-gray-700"},"Пользовательский промпт (необязательно)",-1)),v(t("input",{id:"custom_prompt",type:"text","onUpdate:modelValue":e[2]||(e[2]=l=>n(s).custom_prompt=l),placeholder:"Дополнительные указания для генерации, например: в старорусском стиле",class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"},null,512),[[T,n(s).custom_prompt]]),e[18]||(e[18]=t("div",{class:"text-sm text-gray-500 mt-1"},"Дополнительные указания для модели при генерации контента",-1))]),t("div",fe,[t("button",{type:"button",onClick:$,onMousedown:e[3]||(e[3]=l=>console.log("Button mousedown")),onMouseup:e[4]||(e[4]=l=>console.log("Button mouseup")),class:X(["px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center",{"opacity-50 cursor-not-allowed":r.value||!n(s).channel_id}]),disabled:r.value||!n(s).channel_id},[r.value?(i(),a("svg",ve,e[19]||(e[19]=[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):c("",!0),V(" "+g(r.value?"Генерация...":"Сгенерировать пост"),1)],42,be),t("div",xe,[t("span",he,g(D())+" символов",1)])]),t("div",ye,[e[21]||(e[21]=t("label",{for:"content",class:"block text-sm font-medium text-gray-700 mb-1"},"Текст поста",-1)),r.value?(i(),a("div",we,e[20]||(e[20]=[t("div",{class:"text-center"},[t("p",{class:"text-lg font-medium text-gray-800 mb-2"},"Генерируем пост..."),t("p",{class:"text-sm text-gray-600"},"Пожалуйста, подождите")],-1)]))):c("",!0),v(t("textarea",{id:"content","onUpdate:modelValue":e[5]||(e[5]=l=>n(s).content=l),rows:"10",disabled:r.value,class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"},null,8,ke),[[T,n(s).content]]),d.errors.content?(i(),a("div",_e,g(d.errors.content),1)):c("",!0)]),t("div",Ce,[e[24]||(e[24]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Параметры публикации",-1)),t("div",Me,[t("div",null,[v(t("input",{type:"radio",id:"publish-now",value:"now","onUpdate:modelValue":e[6]||(e[6]=l=>n(s).publish_type=l),class:"focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300"},null,512),[[E,n(s).publish_type]]),e[22]||(e[22]=t("label",{for:"publish-now",class:"ml-2 text-sm text-gray-700"},"Опубликовать сейчас",-1))]),t("div",null,[v(t("input",{type:"radio",id:"publish-scheduled",value:"scheduled","onUpdate:modelValue":e[7]||(e[7]=l=>n(s).publish_type=l),class:"focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300"},null,512),[[E,n(s).publish_type]]),e[23]||(e[23]=t("label",{for:"publish-scheduled",class:"ml-2 text-sm text-gray-700"},"Запланировать публикацию",-1))])]),d.errors.publish_type?(i(),a("div",Te,g(d.errors.publish_type),1)):c("",!0)]),n(s).publish_type==="scheduled"?(i(),a("div",Ae,[e[25]||(e[25]=t("label",{for:"scheduled_at",class:"block text-sm font-medium text-gray-700"},"Дата и время публикации",-1)),v(t("input",{id:"scheduled_at",type:"datetime-local","onUpdate:modelValue":e[8]||(e[8]=l=>n(s).scheduled_at=l),class:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"},null,512),[[T,n(s).scheduled_at]]),d.errors.scheduled_at?(i(),a("div",Ge,g(d.errors.scheduled_at),1)):c("",!0)])):c("",!0),t("div",Se,[C(n(j),{href:o.route("posts.index"),class:"px-4 py-2 bg-gray-200 text-gray-700 rounded-md mr-2 hover:bg-gray-300"},{default:M(()=>e[26]||(e[26]=[V(" Отмена ")])),_:1},8,["href"]),e[27]||(e[27]=t("button",{type:"submit",class:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"}," Создать пост ",-1))])],32)])])])])]),_:1})],64))}};export{ze as default};
